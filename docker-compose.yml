version: "3.8"

services:
  # -------------------- DATABASE --------------------
  postgres:
    image: postgres:14-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # -------------------- REDIS --------------------
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # -------------------- OPENTELEMETRY COLLECTOR --------------------
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.143.1
    container_name: otel-collector
    command: ["--config=/etc/otel/config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel/config.yaml
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "9464:9464"   # Prometheus scrape
    depends_on:
      - postgres
      - redis

  # -------------------- PROMETHEUS --------------------
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    ports:
      - "9090:9090"

  # -------------------- LOKI (LOGS) --------------------
  loki:
    image: grafana/loki:2.9.0
    container_name: loki
    command: -config.file=/etc/loki/loki-config.yaml
    ports:
      - "3100:3100"
    volumes:
      - ./loki/loki-config.yaml:/etc/loki/loki-config.yaml
      - loki_data:/loki


  # -------------------- TEMPO (TRACES) --------------------
  tempo:
    image: grafana/tempo:2.3.1
    container_name: tempo
    command: ["-config.file=/etc/tempo/tempo.yaml"]
    volumes:
      - ./tempo/tempo.yaml:/etc/tempo/tempo.yaml
      - tempo_data:/var/tempo
    ports:
      - "3200:3200"   # Tempo UI

  # -------------------- GRAFANA -------------------- 
  grafana:
    image: grafana/grafana:10.2.2
    container_name: grafana
    ports:
      - "3006:3000"
    depends_on:
      - prometheus
      - loki
      - tempo
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning

  # -------------------- USER SERVICE --------------------
  user-service:
    build: ./services/user-service
    container_name: user-service
    ports:
      - "3001:3001"
    environment:
      PORT: 3001
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/ecommerce_users
      JWT_SECRET: your-secret-key
      OTEL_SERVICE_NAME: user-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
    depends_on:
      - postgres
      - otel-collector

  # -------------------- PRODUCT SERVICE --------------------
  product-service:
    build: ./services/product-service
    container_name: product-service
    ports:
      - "3002:3002"
    environment:
      PORT: 3002
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/ecommerce_products
      OTEL_SERVICE_NAME: product-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
    depends_on:
      - postgres
      - otel-collector

  # -------------------- CART SERVICE --------------------
  cart-service:
    build: ./services/cart-service
    container_name: cart-service
    ports:
      - "3003:3003"
    environment:
      PORT: 3003
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/ecommerce_carts
      REDIS_URL: redis://redis:6379
      PRODUCT_SERVICE_URL: http://product-service:3002
      OTEL_SERVICE_NAME: cart-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
    depends_on:
      - postgres
      - redis
      - otel-collector

  # -------------------- INVENTORY SERVICE --------------------
  inventory-service:
    build: ./services/inventory-service
    container_name: inventory-service
    ports:
      - "3005:3005"
    environment:
      PORT: 3005
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/ecommerce_inventory
      PRODUCT_SERVICE_URL: http://product-service:3002
      OTEL_SERVICE_NAME: inventory-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
    depends_on:
      - postgres
      - product-service
      - otel-collector

  # -------------------- ORDER SERVICE --------------------
  order-service:
    build: ./services/order-service
    container_name: order-service
    ports:
      - "3004:3004"
    environment:
      PORT: 3004
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/ecommerce_orders
      CART_SERVICE_URL: http://cart-service:3003
      PRODUCT_SERVICE_URL: http://product-service:3002
      INVENTORY_SERVICE_URL: http://inventory-service:3005
      OTEL_SERVICE_NAME: order-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
    depends_on:
      - postgres
      - cart-service
      - inventory-service
      - otel-collector

  # -------------------- API GATEWAY --------------------
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports:
      - "3000:3000"
    environment:
      PORT: 3000
      USER_SERVICE_URL: http://user-service:3001
      PRODUCT_SERVICE_URL: http://product-service:3002
      CART_SERVICE_URL: http://cart-service:3003
      ORDER_SERVICE_URL: http://order-service:3004
      INVENTORY_SERVICE_URL: http://inventory-service:3005
      OTEL_SERVICE_NAME: api-gateway
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
    depends_on:
      - user-service
      - product-service
      - cart-service
      - order-service
      - inventory-service
      - otel-collector

  # -------------------- FRONTEND --------------------
  frontend:
    build: ./frontend
    container_name: frontend
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://localhost:3000
    depends_on:
      - api-gateway

volumes:
  postgres_data:
  redis_data:
  grafana_data:
  loki_data:
  tempo_data:
