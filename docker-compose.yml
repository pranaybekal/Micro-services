version: '3.8'

services:
  # -------------------- DATABASE --------------------
  postgres:
    image: postgres:14-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # -------------------- REDIS --------------------
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # -------------------- OPENTELEMETRY COLLECTOR --------------------
  otel-collector:
    image: otel/opentelemetry-collector:latest
    command: ["--config=/etc/otel/config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel/config.yaml
    ports:
      - "4318:4318"
      - "4317:4317"

  # -------------------- USER SERVICE --------------------
  user-service:
    build: ./services/user-service
    ports:
      - "3001:3001"
    environment:
      - PORT=3001
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ecommerce_users
      - JWT_SECRET=your-secret-key-change-in-production
      - OTEL_SERVICE_NAME=user-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    depends_on:
      - postgres
      - otel-collector
    volumes:
      - ./services/user-service:/app
      - /app/node_modules

  # -------------------- PRODUCT SERVICE --------------------
  product-service:
    build: ./services/product-service
    ports:
      - "3002:3002"
    environment:
      - PORT=3002
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ecommerce_products
      - OTEL_SERVICE_NAME=product-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    depends_on:
      - postgres
      - otel-collector
    volumes:
      - ./services/product-service:/app
      - /app/node_modules

  # -------------------- CART SERVICE --------------------
  cart-service:
    build: ./services/cart-service
    ports:
      - "3003:3003"
    environment:
      - PORT=3003
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ecommerce_carts
      - REDIS_URL=redis://redis:6379
      - PRODUCT_SERVICE_URL=http://product-service:3002
      - CART_SERVICE_URL=http://cart-service:3003
      - OTEL_SERVICE_NAME=cart-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    depends_on:
      - postgres
      - redis
      - otel-collector
    volumes:
      - ./services/cart-service:/app
      - /app/node_modules

  # -------------------- INVENTORY SERVICE --------------------
  inventory-service:
    build: ./services/inventory-service
    ports:
      - "3005:3005"
    environment:
      - PORT=3005
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ecommerce_inventory
      - PRODUCT_SERVICE_URL=http://product-service:3002
      - OTEL_SERVICE_NAME=inventory-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    depends_on:
      - postgres
      - product-service
      - otel-collector
    volumes:
      - ./services/inventory-service:/app
      - /app/node_modules

  # -------------------- ORDER SERVICE --------------------
  order-service:
    build: ./services/order-service
    ports:
      - "3004:3004"
    environment:
      - PORT=3004
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ecommerce_orders
      - CART_SERVICE_URL=http://cart-service:3003
      - PRODUCT_SERVICE_URL=http://product-service:3002
      - INVENTORY_SERVICE_URL=http://inventory-service:3005
      - OTEL_SERVICE_NAME=order-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    depends_on:
      - postgres
      - cart-service
      - inventory-service
      - otel-collector
    volumes:
      - ./services/order-service:/app
      - /app/node_modules

  # -------------------- API GATEWAY --------------------
  api-gateway:
    build: ./api-gateway
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - USER_SERVICE_URL=http://user-service:3001
      - PRODUCT_SERVICE_URL=http://product-service:3002
      - CART_SERVICE_URL=http://cart-service:3003
      - ORDER_SERVICE_URL=http://order-service:3004
      - INVENTORY_SERVICE_URL=http://inventory-service:3005
      - OTEL_SERVICE_NAME=api-gateway
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    depends_on:
      - user-service
      - product-service
      - cart-service
      - order-service
      - inventory-service
      - otel-collector
    volumes:
      - ./api-gateway:/app
      - /app/node_modules

  # -------------------- FRONTEND --------------------
  frontend:
    build: ./frontend
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:3000
    depends_on:
      - api-gateway
    volumes:
      - ./frontend:/app
      - /app/node_modules

volumes:
  postgres_data:
  redis_data:
  frontend_data:
